echo -e "# official nginx repo\ndeb http://nginx.org/packages/debian/ squeeze nginx\ndeb-src http://nginx.org/packages/debian/ squeeze nginx" > /etc/apt/sources.list.d/nginx.sources.list
wget http://nginx.org/keys/nginx_signing.key && apt-key add nginx_signing.key
apt-get update && apt-get dist-upgrade

cd /tmp && apt-get source nginx && apt-get build-dep nginx

# если нужны какие-то модули >>>
mkdir ./nginx-modules
# там в патче добавленны все модули которые я часто использую и удалены те которые мне редко нужны, если что то надо править ручками
# TODO в перспективе "разбомбить" на отдельнгые патчи
wget https://raw.github.com/pioneer32/debian/master/nginx/nginx-1.4.X-debian-rules.patch
patch ./nginx-1.4.*/debian/rules < ./nginx-1.4.X-debian-rules.patch
# и если надо дебаг то еще добавим --with-debug в ./nginx-1.4.*/debian/rules

# если нужен модуль ngx_http_redis >>>
wget http://people.freebsd.org/~osa/ngx_http_redis-0.3.6.tar.gz
tar vfx ./ngx_http_redis-0.3.6.tar.gz -C ./nginx-modules/

# если нужен модуль nginx_upload_module >>>
wget http://www.grid.net.ru/nginx/download/nginx_upload_module-2.2.0.tar.gz
tar xvf ./nginx_upload_module-2.2.0.tar.gz -C ./nginx-modules/
wget https://raw.github.com/pioneer32/debian/master/nginx/nginx-1.3.9_upload_module.patch
patch ./nginx-modules/nginx_upload_module-2.2.0/ngx_http_upload_module.c < ./nginx-1.3.9_upload_module.patch

# если нужен nginx_http_lua
apt-get install lua5.1 liblua5.1-0 liblua5.1-0-dev luarocks libreadline-dev libncurses5-dev libpcre3-dev libssl-dev perl make
luarocks install luasocket && luarocks install lua-cjson
# TODO добавить установку luajit
ln -s /usr/lib/x86_64-linux-gnu/liblua5.1.so /usr/lib/liblua.so
wget -O ./ngx_devel_kit_v0.2.19.tar.gz https://github.com/simpl/ngx_devel_kit/archive/v0.2.19.tar.gz
tar xvf ./ngx_devel_kit_v0.2.19.tar.gz -C ./nginx-modules/
wget -O ./lua_nginx_module_v0.9.0.tar.gz https://github.com/chaoslawful/lua-nginx-module/archive/v0.9.0.tar.gz
tar xvf ./lua_nginx_module_v0.9.0.tar.gz -C ./nginx-modules/
# если есть luajit
export LUAJIT_LIB=/path/to/luajit/lib
export LUAJIT_INC=/path/to/luajit/include/luajit-2.0

cd ./nginx-modules/ && git clone https://github.com/agentzh/lua-resty-redis.git && cd ..

# добавим в ./nginx-1.4.*/debian/rules
\
--add-module=/tmp/nginx-modules/ngx_devel_kit-0.2.19 \
--add-module=/tmp/nginx-modules/lua-nginx-module-0.9.0 \
--add-module=/tmp/nginx-modules/lua-resty-redis

cd /tmp/nginx-modules/ngx_openresty-1.2.8.6
./configure --without-http_echo_module --without-http_xss_module --without-http_coolkit_module --without-http_set_misc_module --without-http_encrypted_session_module \
--without-http_form_input_module --without-http_array_var_module --without-http_auth_request_module --without-http_headers_more_module --without-lua_resty_memcached --without-http_memc_module \
--without-ngx_devel_kit_module --without-lua_cjson --without-lua_rds_parser --without-lua_redis_parser --without-lua_resty_memcached --without-lua_resty_mysql --without-lua_resty_string \
--without-lua_resty_upload --without-http_rds_csv_module --without-http_rds_json_module --without-http_redis_module --without-http_redis2_module -j2
 
# --with-luajit --with-lua_resty_redis

# под вопросом LuaRestyMemcachedLibrary LuaRestyMySQLLibrary LuaRestyStringLibrary LuaRedisParserLibrary LuaRestyWebSocketLibrary
# пара моментов, надо разобраться, вроде как в рести уже входят несколько модулей, которые я собираю отдельно: ngx_devel_kit_module, lua-cjson, HttpLuaModule, HttpRedisModule

make && make install

cd ./nginx-1.4.*
dpkg-buildpackage -rfakeroot

# задрали версии менять... смотрим как называется ls -la ../nginx*.deb
dpkg -i ../nginx_1.4.2-1~squeeze_amd64.deb

# проверил nginx -V
echo 'nginx hold' | dpkg --set-selections && echo 'nginx-debug hold' | dpkg --set-selections

# если нужно
wget -qO- https://raw.github.com/pioneer32/debian/master/nginx.conf > /etc/nginx/nginx.conf

# правим конфиг
nano /etc/nginx/nginx.conf

# для munin
# тут момент, что для работы munin надо чтобы был ответ stub_status nginx (подробности в https://raw.github.com/pioneer32/debian/master/nginx.conf)
ln -s /usr/share/munin/plugins/nginx_request /etc/munin/plugins/nginx_request
ln -s /usr/share/munin/plugins/nginx_status /etc/munin/plugins/nginx_status
